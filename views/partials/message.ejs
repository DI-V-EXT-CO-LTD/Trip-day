<style>
.message-container {
  max-width: 900px;
  margin: 20px auto;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.message-item {
  padding: 15px;
  border-bottom: 1px solid #eee;
  display: flex;
  align-items: center;
  cursor: pointer;
  transition: background-color 0.2s;
}

.message-item:hover {
  background-color: #f8f9fa;
}

.message-item.unread {
  background-color: #f0f7ff;
  font-weight: 600;
}

.message-icon {
  width: 40px;
  height: 40px;
  background: #e9ecef;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
}

.message-content {
  flex-grow: 1;
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
}

.message-sender {
  color: #495057;
}

.message-date {
  color: #6c757d;
  font-size: 0.9em;
}

.message-preview {
  color: #6c757d;
  font-size: 0.95em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 600px;
}

.message-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}

.message-modal-content {
  position: relative;
  background: #fff;
  width: 80%;
  max-width: 800px;
  margin: 50px auto;
  padding: 20px;
  border-radius: 8px;
  max-height: 80vh;
  overflow-y: auto;
}

.close-modal {
  position: absolute;
  right: 20px;
  top: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #6c757d;
}

.message-full-content {
  white-space: pre-wrap;
  margin-top: 20px;
  line-height: 1.6;
}
</style>

<div class="message-container">
  <% messages.forEach(function(message) { %>
    <div class="message-item <%= !message.isRead ? 'unread' : '' %>" onclick="showMessage('<%= message._id %>', this)">
      <div class="message-icon">
        <i class="fas fa-envelope<%= message.isRead ? '-open' : '' %>"></i>
      </div>
      <div class="message-content">
        <div class="message-header">
          <span class="message-sender"><%= message.sender || 'TRIP-DAY' %></span>
          <span class="message-date"><%= new Date(message.createdAt).toLocaleString() %></span>
        </div>
        <div class="message-preview">
          <%= message.content.replace(/\n/g, ' ').trim() %>
        </div>
      </div>
    </div>
  <% }); %>
</div>

<div id="messageModal" class="message-modal">
  <div class="message-modal-content">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <h4 id="modalSender"></h4>
    <div id="modalDate" style="color: #6c757d; margin-bottom: 15px;"></div>
    <div id="modalContent" class="message-full-content"></div>
  </div>
</div>

<script>
function showMessage(messageId, element) {
  const modal = document.getElementById('messageModal');
  const modalContent = document.getElementById('modalContent');
  const modalSender = document.getElementById('modalSender');
  const modalDate = document.getElementById('modalDate');
  
  // Get message data from the element
  const sender = element.querySelector('.message-sender').textContent;
  const date = element.querySelector('.message-date').textContent;
  const content = element.querySelector('.message-preview').textContent;
  
  modalSender.textContent = sender;
  modalDate.textContent = date;
  modalContent.textContent = content;
  
  modal.style.display = 'block';
  
  // Mark message as read
  if (element.classList.contains('unread')) {
    fetch(`/messages/${messageId}/read`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        element.classList.remove('unread');
        updateUnreadCount();
      }
    })
    .catch(error => console.error('Error:', error));
  }
}

function closeModal() {
  document.getElementById('messageModal').style.display = 'none';
}

function updateUnreadCount() {
  const unreadCount = document.querySelectorAll('.message-item.unread').length;
  const badge = document.querySelector('.badge-danger');
  if (badge) {
    if (unreadCount > 0) {
      badge.textContent = unreadCount;
    } else {
      badge.style.display = 'none';
    }
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('messageModal');
  if (event.target == modal) {
    closeModal();
  }
}
</script>
